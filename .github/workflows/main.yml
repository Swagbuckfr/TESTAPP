name: ðŸš€ RDP via Ngrok

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Session duration (minutes)'
        required: true
        default: '60'
        type: choice
        options:
          - '30'
          - '60'
          - '120'
          - '240'
          - '36000'

permissions:
  contents: read

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ inputs.duration }}

    env:
      RDP_USER: 'github-runner'
      LOG_FILE: 'C:\ngrok.log'

    steps:
    # Step 1: Initialize
    - name: ðŸ“ Check workflow
      run: |
        Write-Host "========================================"
        Write-Host "   GitHub Actions RDP Setup Starting"
        Write-Host "   Time: $(Get-Date)"
        Write-Host "   Runner: $env:RUNNER_NAME"
        Write-Host "========================================"

    # Step 2: Configure RDP
    - name: âš™ï¸ Configure Remote Desktop
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        
        # Configure firewall
        netsh advfirewall firewall add rule name="GitHub-RDP" dir=in action=allow protocol=TCP localport=3389
        
        # Restart service
        Restart-Service TermService -Force
        Write-Host "âœ… RDP Enabled on port 3389"

    # Step 3: Create User
    - name: ðŸ‘¤ Create RDP User
      run: |
        # Generate a random password
        $Password = [System.Web.Security.Membership]::GeneratePassword(12, 2)
        $SecurePassword = ConvertTo-SecureString $Password -AsPlainText -Force
        
        # Create user
        New-LocalUser -Name "$env:RDP_USER" -Password $SecurePassword -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "$env:RDP_USER"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "$env:RDP_USER"
        
        # Store password for display
        echo "RDP_PASSWORD=$Password" >> $env:GITHUB_ENV
        Write-Host "âœ… User '$env:RDP_USER' created"

    # Step 4: Install Ngrok
    - name: ðŸ”§ Install Ngrok
      run: |
        # Download and install ngrok
        $ngrokUrl = "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip"
        $ngrokZip = "C:\ngrok.zip"
        $ngrokDir = "C:\ngrok"
        
        # Download
        Invoke-WebRequest -Uri $ngrokUrl -OutFile $ngrokZip
        
        # Extract
        Expand-Archive -Path $ngrokZip -DestinationPath $ngrokDir -Force
        
        # Add to PATH
        $env:Path += ";$ngrokDir"
        [Environment]::SetEnvironmentVariable("Path", $env:Path + ";$ngrokDir", "Machine")
        
        Remove-Item $ngrokZip -Force
        Write-Host "âœ… Ngrok installed"

    # Step 5: Setup Ngrok Tunnel
    - name: ðŸŒ Start Ngrok Tunnel
      id: ngrok
      run: |
        # Set auth token
        $authToken = "${{ secrets.NGROK_AUTH_TOKEN }}"
        if ([string]::IsNullOrEmpty($authToken)) {
            Write-Error "âŒ NGROK_AUTH_TOKEN secret is required!"
            Write-Host "Please add your Ngrok auth token to repository secrets"
            Write-Host "Get it from: https://dashboard.ngrok.com/get-started/your-authtoken"
            exit 1
        }
        
        # Configure ngrok
        & "C:\ngrok\ngrok.exe" config add-authtoken $authToken
        
        # Start tunnel in background
        Start-Process -FilePath "C:\ngrok\ngrok.exe" `
          -ArgumentList "tcp 3389 --log $env:LOG_FILE" `
          -WindowStyle Hidden `
          -PassThru
        
        Write-Host "â³ Waiting for tunnel to establish..."
        Start-Sleep -Seconds 10
        
        # Get tunnel URL
        $tries = 0
        $maxTries = 20
        $tunnelUrl = $null
        
        while ($tries -lt $maxTries -and -not $tunnelUrl) {
            try {
                $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 5
                if ($response.tunnels -and $response.tunnels.Count -gt 0) {
                    $tunnelUrl = $response.tunnels[0].public_url
                    Write-Host "âœ… Tunnel established!"
                }
            } catch {
                $tries++
                Write-Host "Attempt $tries/$maxTries: Waiting for tunnel..."
                Start-Sleep -Seconds 2
            }
        }
        
        if (-not $tunnelUrl) {
            Write-Error "âŒ Failed to establish tunnel"
            if (Test-Path $env:LOG_FILE) {
                Get-Content $env:LOG_FILE -Tail 10
            }
            exit 1
        }
        
        # Extract host and port
        $rdpEndpoint = $tunnelUrl -replace 'tcp://', ''
        echo "RDP_ENDPOINT=$rdpEndpoint" >> $env:GITHUB_ENV
        echo "TUNNEL_URL=$tunnelUrl" >> $env:GITHUB_ENV

    # Step 6: Display Connection Info
    - name: ðŸ“‹ Show Connection Details
      run: |
        $border = "â•" * 50
        Write-Host ""
        Write-Host "â•”$borderâ•—"
        Write-Host "â•‘$((' REMOTE DESKTOP READY '.PadCenter(50)))â•‘"
        Write-Host "â•š$borderâ•"
        Write-Host ""
        Write-Host "ðŸ”— CONNECT USING:"
        Write-Host "   Address: $env:RDP_ENDPOINT"
        Write-Host "   Username: $env:RDP_USER"
        Write-Host "   Password: $env:RDP_PASSWORD"
        Write-Host ""
        Write-Host "ðŸ“Œ INSTRUCTIONS:"
        Write-Host "   1. Open Remote Desktop Connection (mstsc.exe)"
        Write-Host "   2. Enter the Address above"
        Write-Host "   3. Use the credentials shown"
        Write-Host ""
        Write-Host "â° SESSION WILL END IN: ${{ inputs.duration }} minutes"
        Write-Host ""
        Write-Host "â•$borderâ•"

    # Step 7: Keep Alive
    - name: â° Maintain Session
      run: |
        $duration = ${{ inputs.duration }}
        $endTime = (Get-Date).AddMinutes($duration)
        
        while ((Get-Date) -lt $endTime) {
            $remaining = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 1)
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Session active. $remaining minutes remaining..."
            
            # Check tunnel health
            try {
                $status = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 5
                Write-Host "   Tunnel Status: âœ… Connected"
            } catch {
                Write-Host "   Tunnel Status: âš ï¸ Checking..."
            }
            
            Start-Sleep -Seconds 30
        }
        
        Write-Host "â° Session time complete. Shutting down..."

    # Step 8: Cleanup (always runs)
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        Write-Host "Cleaning up..."
        
        # Stop ngrok
        Get-Process -Name ngrok -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
        
        # Disable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force
        
        # Remove firewall rule
        netsh advfirewall firewall delete rule name="GitHub-RDP" 2>$null
        
        Write-Host "âœ… Cleanup complete"
