name: ðŸš€ RDP via Ngrok

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Session duration (minutes)'
        required: true
        default: '60'
        type: choice
        options:
          - '30'
          - '60'
          - '120'
          - '180'
          - '240'
          - '360'

permissions:
  contents: read

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ fromJSON('{
      "30": 40,
      "60": 70,
      "120": 130,
      "180": 190,
      "240": 250,
      "360": 370
    }')[github.event.inputs.duration] }}

    env:
      RDP_USER: 'github-runner'
      LOG_FILE: 'C:\ngrok.log'

    steps:
    # Step 1: Initialize
    - name: ðŸ“ Check workflow
      run: |
        Write-Host "========================================"
        Write-Host "   GitHub Actions RDP Setup Starting"
        Write-Host "   Duration: ${{ github.event.inputs.duration }} minutes"
        Write-Host "   Time: $(Get-Date)"
        Write-Host "========================================"

    # Step 2: Configure RDP
    - name: âš™ï¸ Configure Remote Desktop
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        
        # Configure firewall
        netsh advfirewall firewall add rule name="GitHub-RDP" dir=in action=allow protocol=TCP localport=3389
        
        # Restart service
        Restart-Service TermService -Force
        Write-Host "âœ… RDP Enabled on port 3389"

    # Step 3: Create User
    - name: ðŸ‘¤ Create RDP User
      run: |
        # Generate a random password
        Add-Type -AssemblyName System.Web
        $Password = [System.Web.Security.Membership]::GeneratePassword(12, 2)
        $SecurePassword = ConvertTo-SecureString $Password -AsPlainText -Force
        
        # Remove existing user if exists
        $existingUser = Get-LocalUser -Name "$env:RDP_USER" -ErrorAction SilentlyContinue
        if ($existingUser) {
            Remove-LocalUser -Name "$env:RDP_USER" -Confirm:$false
        }
        
        # Create user
        New-LocalUser -Name "$env:RDP_USER" -Password $SecurePassword -AccountNeverExpires -PasswordNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "$env:RDP_USER"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "$env:RDP_USER"
        
        # Store password for display
        echo "RDP_PASSWORD=$Password" >> $env:GITHUB_ENV
        Write-Host "âœ… User '$env:RDP_USER' created"

    # Step 4: Install Ngrok
    - name: ðŸ”§ Install Ngrok
      run: |
        # Download and install ngrok
        $ngrokUrl = "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip"
        $ngrokZip = "$env:TEMP\ngrok.zip"
        $ngrokDir = "$env:TEMP\ngrok"
        
        Write-Host "ðŸ“¥ Downloading ngrok..."
        Invoke-WebRequest -Uri $ngrokUrl -OutFile $ngrokZip
        
        Write-Host "ðŸ“‚ Extracting ngrok..."
        Expand-Archive -Path $ngrokZip -DestinationPath $ngrokDir -Force
        
        # Add to PATH
        $env:Path = "$ngrokDir;$env:Path"
        
        Remove-Item $ngrokZip -Force
        Write-Host "âœ… Ngrok installed"

    # Step 5: Setup Ngrok Tunnel
    - name: ðŸŒ Start Ngrok Tunnel
      id: ngrok
      run: |
        # Set auth token
        $authToken = "${{ secrets.NGROK_AUTH_TOKEN }}"
        if ([string]::IsNullOrEmpty($authToken)) {
            Write-Error "âŒ NGROK_AUTH_TOKEN secret is required!"
            Write-Host "Please add your Ngrok auth token to repository secrets"
            Write-Host "Get it from: https://dashboard.ngrok.com/get-started/your-authtoken"
            exit 1
        }
        
        Write-Host "ðŸ”‘ Configuring ngrok auth..."
        ngrok config add-authtoken $authToken
        
        # Clean up old logs
        if (Test-Path $env:LOG_FILE) {
            Remove-Item $env:LOG_FILE -Force
        }
        
        Write-Host "ðŸŒ Starting ngrok tunnel..."
        # Start ngrok
        Start-Process -FilePath "ngrok" `
          -ArgumentList "tcp 3389 --log $env:LOG_FILE" `
          -WindowStyle Hidden `
          -PassThru
        
        Write-Host "â³ Waiting for tunnel to establish..."
        Start-Sleep -Seconds 5
        
        # Get tunnel URL
        $tries = 0
        $maxTries = 30
        $tunnelUrl = $null
        
        while ($tries -lt $maxTries -and -not $tunnelUrl) {
            try {
                $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 3
                if ($response.tunnels -and $response.tunnels.Count -gt 0) {
                    $tunnel = $response.tunnels | Where-Object { $_.proto -eq 'tcp' }
                    if ($tunnel) {
                        $tunnelUrl = $tunnel.public_url
                        Write-Host "âœ… Tunnel established: $tunnelUrl"
                    }
                }
            } catch {
                $tries++
                if ($tries % 5 -eq 0) {
                    Write-Host "Attempt $tries/$maxTries: Waiting for tunnel..."
                }
                Start-Sleep -Seconds 2
            }
        }
        
        if (-not $tunnelUrl) {
            Write-Error "âŒ Failed to establish tunnel after $maxTries attempts"
            if (Test-Path $env:LOG_FILE) {
                Write-Host "Last 20 lines of ngrok log:"
                Get-Content $env:LOG_FILE -Tail 20
            }
            exit 1
        }
        
        # Extract host and port
        $rdpEndpoint = $tunnelUrl -replace 'tcp://', ''
        echo "RDP_ENDPOINT=$rdpEndpoint" >> $env:GITHUB_ENV
        echo "TUNNEL_URL=$tunnelUrl" >> $env:GITHUB_ENV

    # Step 6: Display Connection Info
    - name: ðŸ“‹ Show Connection Details
      run: |
        $duration = ${{ github.event.inputs.duration }}
        $border = "â•" * 50
        
        Write-Host ""
        Write-Host "â•”$borderâ•—"
        Write-Host "â•‘$((' REMOTE DESKTOP READY '.PadCenter(50)))â•‘"
        Write-Host "â•š$borderâ•"
        Write-Host ""
        Write-Host "ðŸ”— CONNECTION DETAILS:"
        Write-Host ""
        Write-Host "   Address:  $env:RDP_ENDPOINT"
        Write-Host "   Username: $env:RDP_USER"
        Write-Host "   Password: $env:RDP_PASSWORD"
        Write-Host ""
        Write-Host "ðŸ“Œ HOW TO CONNECT:"
        Write-Host "   1. Press Win + R, type 'mstsc', press Enter"
        Write-Host "   2. Enter: $env:RDP_ENDPOINT"
        Write-Host "   3. Click 'Connect'"
        Write-Host "   4. Use username: $env:RDP_USER"
        Write-Host "   5. Use password shown above"
        Write-Host ""
        Write-Host "â° SESSION DURATION: $duration minutes"
        Write-Host ""
        Write-Host "âš ï¸  IMPORTANT:"
        Write-Host "   - This is a temporary session"
        Write-Host "   - All data will be lost when session ends"
        Write-Host "   - Maximum $duration minutes runtime"
        Write-Host ""
        Write-Host "â•$borderâ•"

    # Step 7: Keep Alive
    - name: â° Maintain Session
      run: |
        $duration = [int]${{ github.event.inputs.duration }}
        $endTime = (Get-Date).AddMinutes($duration)
        
        while ((Get-Date) -lt $endTime) {
            $remaining = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 1)
            
            # Clear line and show progress
            $progress = "â–°" * [math]::Min([math]::Floor($remaining / $duration * 20), 20)
            $empty = "â–±" * (20 - $progress.Length)
            
            Write-Host "`r[$(Get-Date -Format 'HH:mm:ss')] Time left: ${remaining}m [$progress$empty]" -NoNewline
            
            # Check tunnel health every minute
            if ([math]::Floor($remaining) % 1 -eq 0) {
                try {
                    $status = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 3
                    Write-Host " âœ… Connected" -NoNewline
                } catch {
                    Write-Host " âš ï¸  Checking..." -NoNewline
                }
            }
            
            Start-Sleep -Seconds 5
        }
        
        Write-Host ""
        Write-Host "â° Session time complete. Shutting down..."

    # Step 8: Cleanup (always runs)
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        Write-Host "Starting cleanup..."
        
        # Stop ngrok
        Write-Host "Stopping ngrok..."
        Get-Process -Name ngrok -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2
        
        # Disable RDP
        Write-Host "Disabling RDP..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force
        
        # Remove firewall rule
        Write-Host "Removing firewall rule..."
        netsh advfirewall firewall delete rule name="GitHub-RDP" 2>$null
        
        # Remove temporary user
        Write-Host "Removing user..."
        Get-LocalUser -Name "$env:RDP_USER" -ErrorAction SilentlyContinue | Remove-LocalUser -Confirm:$false
        
        # Restart RDP service
        Restart-Service TermService -Force -ErrorAction SilentlyContinue
        
        Write-Host "âœ… Cleanup complete"
