name: NV

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360000

    steps:
      # 1. Enable RDP (Local configuration only, no external firewall rules needed for Avica)
      - name: Configure RDP Settings
        run: |
          # Allow RDP connections locally
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          # Note: Firewall rules for port 3389 are removed since we are not using Ngrok.
          # If you plan to use a different tunnel later, you may need to open the firewall manually.
          Restart-Service -Name TermService -Force

      # 2. Manage Users and Passwords
      - name: Reset Admin Passwords
        run: |
          $password = "D12345678@"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          Write-Host "Resetting runneradmin password..."
          Set-LocalUser -Name "runneradmin" -Password $securePass
          
          if (-not (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member "RDP"
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          } else {
              Set-LocalUser -Name "RDP" -Password $securePass
          }

      # 3. Change DNS to Google
      - name: Set DNS to Google (8.8.8.8 / 8.8.4.4)
        run: |
          $activeAdapter = Get-NetIPConfiguration | Where-Object { $_.IPv4DefaultGateway -ne $null } | Select-Object -First 1
          
          if ($activeAdapter) {
              Set-DnsClientServerAddress -InterfaceAlias $activeAdapter.InterfaceAlias -ServerAddresses "8.8.8.8", "8.8.4.4"
              Write-Host "DNS changed to 8.8.8.8 / 8.8.4.4 on interface: $($activeAdapter.InterfaceAlias)"
          } else {
              Write-Host "Could not auto-detect active adapter. Trying default 'Ethernet'..."
              Set-DnsClientServerAddress -InterfaceAlias "Ethernet" -ServerAddresses "8.8.8.8", "8.8.4.4"
          }
          Clear-DnsClientCache

      # 4. Install Avica (Replaces Ngrok)
      - name: Install Avica
        run: |
          $ProgressPreference = 'SilentlyContinue'
          $avicaUrl = "https://download.avica.com/downloader/Avica_setup.exe?_gl=1*1eqqu1s*_gcl_au*Mjk2MjI3MjQ5LjE3Njg3NjExMzguMTQ5MzMxOTM4MS4xNzY4NzYxMjkwLjE3Njg3NjEyOTA."
          $installerPath = "$env:TEMP\Avica_setup.exe"
          
          Write-Host "Downloading Avica..."
          Invoke-WebRequest -Uri $avicaUrl -OutFile $installerPath
          
          Write-Host "Installing Avica silently..."
          # Assuming /S or /silent works for the installer. If not, it might hang.
          Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait
          
          Write-Host "Attempting to start Avica..."
          # Common installation path, adjust if necessary
          $avicaExe = "C:\Program Files\Avica\Avica.exe"
          if (Test-Path $avicaExe) {
              Start-Process -FilePath $avicaExe
              Write-Host "Avica started successfully."
          } else {
              Write-Host "Could not find Avica executable at $avicaExe. It may be installed elsewhere."
          }

      # 5. Install Additional Tools (ProxyScrape & Nmap)
      - name: Install Additional Tools
        run: |
          $ProgressPreference = 'SilentlyContinue'
          
          # --- Install ProxyScrape Proxy Checker ---
          $psUrl = "https://downloads.cdn.proxyscrape.com/proxy-checker/proxyscrape-proxy-checker-v1.1.0-x64-win-installer.exe"
          $psOut = "$env:TEMP\proxyscrape-installer.exe"
          Write-Host "Downloading ProxyScrape..."
          Invoke-WebRequest -Uri $psUrl -OutFile $psOut
          Write-Host "Installing ProxyScrape..."
          Start-Process -FilePath $psOut -ArgumentList "/S" -Wait -NoNewWindow
          
          # --- Install Nmap ---
          $nmapUrl = "https://nmap.org/dist/nmap-7.98-setup.exe"
          $nmapOut = "$env:TEMP\nmap-installer.exe"
          Write-Host "Downloading Nmap..."
          Invoke-WebRequest -Uri $nmapUrl -OutFile $nmapOut
          Write-Host "Installing Nmap..."
          Start-Process -FilePath $nmapOut -ArgumentList "/S" -Wait -NoNewWindow
          
          Write-Host "Additional tools installed successfully."

      # 6. Display Connection Info
      - name: Display Connection Info
        run: |
          Write-Host "`n============================================"
          Write-Host "   AVICA REMOTE DESKTOP SETUP COMPLETE"
          Write-Host "============================================"
          Write-Host "NOTE: Ngrok has been removed."
          Write-Host "There is no public IP address to display here."
          Write-Host "--------------------------------------------"
          Write-Host "ACTION REQUIRED:"
          Write-Host "1. Check your Avica Web Console/Device List."
          Write-Host "2. Look for the device named 'WIN-' (Windows Hostname)."
          Write-Host "3. Connect via Avica using that device ID."
          Write-Host "--------------------------------------------"
          Write-Host "LOCAL CREDENTIALS (If needed):"
          Write-Host "Username   : runneradmin"
          Write-Host "Password   : D12345678@"
          Write-Host "Backup User: RDP"
          Write-Host "Backup Pass: D12345678@"
          Write-Host "============================================"
          Write-Host "INSTALLED TOOLS:"
          Write-Host "- Avica Remote Desktop"
          Write-Host "- ProxyScrape Proxy Checker"
          Write-Host "- Nmap"
          Write-Host "============================================`n"
          
          while ($true) {
              Write-Host "[$(Get-Date)] Session Active... Waiting for Avica Connection..."
              Start-Sleep -Seconds 300
          }
